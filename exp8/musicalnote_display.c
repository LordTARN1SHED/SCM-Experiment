#define uchar unsigned char
#define uint unsigned int
#define ulong unsigned long

#include "reg51.h"
#include "stdio.h"
#include "math.h"
#include "stdlib.h"
#include "intrins.h"
#include "string.h"

#define itrtime_us 100            // us
#define refreshtime 2
#define MOTOR_HIGH 0
#define MOTOR_LOW 1
#define HIGH 1
#define LOW 0

// 定义控制引脚
sbit CS = P0^1; // 寄存器选择
sbit SID = P0^0; // 读/写选择
sbit SCLK = P0^3; // 使能信号
sbit RST = P0^2; // 使能信号
sbit RS = P0^1; // 寄存器选择
sbit RW = P0^0; // 读/写选择

sbit CH451_LOAD = P1 ^ 1;   // P1.1
sbit CH451_DIN = P1 ^ 2;        // P1.2
sbit CH451_DCLK = P1 ^ 3;        // P1.3
sbit CH451_DOUT = P3 ^ 3;        // P3.3  INT1
uchar flagarray[8] = { 58,59,50,51,48,49,40,41 };

int itr_num;
int type;
uchar set_freq;
uchar freq;
sbit LCD_SID=P0^0;            // LCD_SID == WR
sbit LCD_CS=P0^1;            // LCD_CS == RS
sbit LCD_RST=P0^2;
sbit LCD_SCLK=P0^3;            // LCD_SCLK == DE
#define CSHIGH 1
#define RSTHIGH 1
#define threshold1 1000
#define threshold2 2000
uchar char_position[4][8]={ {0x80,0x81,0x82,0x83,0x84,0x85,0x86,0x87},
                            {0x90,0x91,0x92,0x93,0x94,0x95,0x96,0x97},
                            {0x88,0x89,0x8A,0x8B,0x8C,0x8D,0x8E,0x8F},
                            {0x98,0x99,0x9A,0x9B,0x9C,0x9D,0x9E,0x9F}};

uchar ifarrived;
uchar dutycycle;        // 占空比  单位%
#define MAX_FREQ 52        // 最大转速
uchar step=5;            // 默认步长
                            
sbit P20=P2^0;
sbit P21=P2^1;
sbit MOTOR_SPEED_IN=P1^5;



const unsigned char code note[8] = {0x20,0x30,0x28,0x28,0x20,0xE0,0xE0,0xE0};

uchar fanptr = 0;
const uchar code background[8194] = {
    64,128,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x3E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x63,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x41,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x41,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x43,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x42,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0x00,0x5C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x70,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x01,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0x1C,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x10,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x10,0xEC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0x11,0x22,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x18,0xA3,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x08,0x61,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0x06,0x46,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x03,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x09,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x0B,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

// delay 10*n us
void delay_10us(uchar n) {
    unsigned char i;
    for (i = n; i > 0; --i) {
        _nop_();
        //_nop_(); //12MHz
    }
}

void delay_ms(uchar n){
    while(n--){
        delay_10us(100);
    }
}

void LCD_write_byte(unsigned char Data) {
    unsigned char i;
    for (i = 0; i < 8; i++) {
        if (Data & 0x80)
            LCD_SID = 1;
        else
            LCD_SID = 0;

        _nop_();
        _nop_();
        LCD_SCLK = 0;
        _nop_();
        LCD_SCLK = 1;
        Data <<= 1;
    }
}

void loadCommand(int command) {
    int i;
    int command_bit[12];
    int temp;
    CH451_LOAD = HIGH; CH451_DCLK = HIGH;
    temp = command;
    for (i = 11; i >= 0; i--) {
        command_bit[i] = temp % 2;
        temp /= 2;
    }
    for (i = 11; i >= 0; i--) {
        CH451_DIN = command_bit[i] ^ LOW;
        CH451_DCLK = LOW; CH451_DCLK = HIGH;
    }
    CH451_LOAD = LOW; CH451_LOAD = HIGH;
    delay_ms(10);
}


void LCD_write_byte_split(unsigned char Data) {
    LCD_write_byte(Data & 0xf0);
    LCD_write_byte((Data << 4) & 0xf0);
}

void LCD_write_data(uchar Data) {
    LCD_SCLK = 0;
    LCD_write_byte(0xfa);
    _nop_();
    LCD_write_byte_split(Data);
    delay_10us(10);
}

void LCD_write_command(unsigned char command) {
    LCD_SCLK = 0;
    LCD_write_byte(0xf8);
    _nop_();
    LCD_write_byte_split(command);
    if (command == 0x01)
        delay_ms(10);
    else
        delay_10us(10);
}
void LCD_init(void) {    //初始化
    LCD_CS = LCD_RST = 1;
    LCD_write_command(0x30);    // 基本指令集
    LCD_write_command(0x08);
    LCD_write_command(0x0c);
    LCD_write_command(0x06);
    LCD_write_command(0x01);
}

void LCD_setposition(uchar x,uchar y){
    LCD_write_command(char_position[x][y]);  // DDRAM
}
void LCD_setposition_dot(uchar row,uchar col){
    if(row>=32){
        LCD_write_command(0x80|(row-32));
        LCD_write_command(0x80|(col+8));
    }
    else{
        LCD_write_command(0x80|row);
        LCD_write_command(0x80|col);
    }
}
void LCD_startGraphic(){
    LCD_write_command(0x34);          // 扩展指令开启
    LCD_write_command(0x36);          // 绘图指令开启
}
void LCD_endGraphic(){
    LCD_write_command(0x36);          // 绘图指令关闭
    LCD_write_command(0x30);          // 扩展指令关闭
}

void LCD_showString(uchar x,uchar y,uchar* p){
    uchar* temp = p;
    uchar length = strlen(p);
    uchar i,j;

    // 白底黑字
    LCD_startGraphic();
    for (i = x * 16; i < x * 16 + 16; i++) {
        LCD_setposition_dot(i, y);
        for (j = 0; j < length; j++) {
            LCD_write_data(0x00);
        }
    }
    LCD_endGraphic();

    // 显示
    LCD_setposition(x, y);
    while(*p){
        LCD_write_data(*p);
        p++;
    }
    
}

void LCD_showNum_uchar(uchar x, uchar y, uchar num){
    uchar freq_str[3] = { '0',32,32};
    uchar div=100;
    uchar temp,digit=3;
    uchar i=0,j;
    temp= num;
    
    if (num > 0) {
        while (div && temp < div) {
            div /= 10; digit--;
        }
        do {
            freq_str[i++] = (uchar)(temp / div + '0');
            temp %= div;
            div /= 10;
        } while (div);
    }
    else
        digit = 1;

    // 白底黑字
    LCD_startGraphic();
    for (i = x * 16; i < x * 16 + 16; i++) {
        LCD_setposition_dot(i, y);
        for (j = 0; j < digit; j++) {
            LCD_write_data(0x00);
        }
    }
    LCD_endGraphic();

    // 显示
    LCD_setposition(x, y);
    for(i=0;i<3;i++){
        LCD_write_data(freq_str[i]);
    }
}

void LCD_showGraphic(uchar *graph, uchar start_row, uchar start_col){
    int i,j;
    int pt;
    int width,height;
    height=graph[0];width=graph[1];
    pt=2;
    LCD_startGraphic();
    for(i=0;i<height;i++){
        LCD_setposition_dot(start_row+i,start_col);
        for(j=0;j<width/8;j++){
            LCD_write_data(graph[pt]);
            pt++;
        }
    }
    LCD_endGraphic();
}
void LCD_clear() {
    uchar i,j;
    LCD_startGraphic();
    for (i = 0; i < 32; i++) {
        LCD_setposition_dot(i, 0);
        for (j = 0; j < 16; j++) {
            LCD_write_data(0x00);
        }
    }
    LCD_endGraphic();

}


void inititr() {
    EA = 1;
    EX0 = 1;        // 允许INT0外部中断
    IT0 = 1;        // INT0边沿触发
    EX1 = 1;        // 允许INT1外部中断
    IT1 = 0;        // INT1电平触发


    TMOD = 0X02;    // 定时器方式2 自动恢复初值
    TH0 = (0xff - itrtime_us);
    TL0 = (0xff - itrtime_us);
    ET0 = 1;        // 允许计时器T0中断
    TR0 = 1;        // 允许计时器T0计数
}

void test() {
    int i;
    LCD_startGraphic();
    for (i = 0; i < 8; i++) {
        LCD_setposition_dot(i, i);
        LCD_write_data(0xff);
        LCD_write_data(0xff);
        LCD_write_data(0xff);
        LCD_write_data(0xff);
    }
}









//以下是FZX代码

void writebit(bit x){
   SCLK=1;
   SID=x;
   SCLK=0;
}


void writebyte(unsigned char byte){
   int i=0;
   bit x=0;
   for(i=7;i>=0;i--){
      x=(byte >> i)&0x01;
      writebit(x);
   }
}

void writeword(unsigned char word){
   unsigned char x;
   unsigned char y;

   CS=1;
   writebyte(0x0FA);
   x=(word >> 4)&0x0F;
   y=word&0x0F;
   x=x<<4;
   y=y<<4;
   writebyte(x);
   writebyte(y);
   CS=0;
}

// 向 LCD 发送命令
void writecmd(unsigned char cmd){
   unsigned char x;
   unsigned char y;
   CS=1;
   writebyte(0xF8);
   x=(cmd >> 4)&0x0F;
   y=cmd&0x0F;
   x=x<<4;
   y=y<<4;
   writebyte(x);
   writebyte(y);
   CS=0;
}


// LCD 初始化
void LCD_Init() {
    
    delay_ms(40); // 上电后等待足够长的时间
    RST=0;
    delay_ms(5);
    RST=1;
    writecmd(0x01); // 清屏
    delay_ms(5);;
    writecmd(0x30); // 基本指令集
    delay_ms(5);
    writecmd(0x0C); // 显示开，光标关
    delay_ms(5);
    writecmd(0x06); //
    delay_ms(5);
    
    // 可以添加更多初始化设置
}

void ddram(unsigned char position){
    RS=0;
    RW=0;
    writecmd(position);
}

void write(char str[]){
    int i;
    for(i=0;str[i]!='\0';i++){
       RS=1;
       RW=0;
       writeword(str[i]);
       delay_ms(1);
    }
}

void main() {
    LCD_Init(); // 初始化 LCD

    // 之后的代码可以进行字符显示、图形处理等
    while(1){
        LCD_showGraphic(background, 0, 0);
        LCD_showGraphic(note, 0, 0);
      
    }
   
}
