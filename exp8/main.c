#define uchar unsigned char
#define uint unsigned int
#define ulong unsigned long
#define _MAIN_C_
#include "reg51.h"
#include "stdio.h"
#include "math.h"
#include "stdlib.h"
#include "intrins.h"
#include "string.h"
#define itrtime_us 100			// us
#define refreshtime 2
#define MOTOR_HIGH 0
#define MOTOR_LOW 1
#define HIGH 1
#define LOW 0

sbit CH451_LOAD = P1 ^ 1;   // P1.1
sbit CH451_DIN = P1 ^ 2;		// P1.2
sbit CH451_DCLK = P1 ^ 3;		// P1.3
sbit CH451_DOUT = P3 ^ 3;		// P3.3  INT1
uchar flagarray[8] = { 58,59,50,51,48,49,40,41 };

int itr_num;
int type;
uchar set_freq;
uchar freq;
sbit LCD_SID=P0^0;			// LCD_SID == WR
sbit LCD_CS=P0^1;			// LCD_CS == RS
sbit LCD_RST=P0^2;			
sbit LCD_SCLK=P0^3;			// LCD_SCLK == DE
#define CSHIGH 1
#define RSTHIGH 1
#define threshold1 1000
#define threshold2 2000
uchar char_position[4][8]={	{0x80,0x81,0x82,0x83,0x84,0x85,0x86,0x87},
							{0x90,0x91,0x92,0x93,0x94,0x95,0x96,0x97},
							{0x88,0x89,0x8A,0x8B,0x8C,0x8D,0x8E,0x8F},
							{0x98,0x99,0x9A,0x9B,0x9C,0x9D,0x9E,0x9F}};

uchar ifarrived;
uchar dutycycle;		// 占空比  单位%
#define MAX_FREQ 52		// 最大转速
uchar step=5;			// 默认步长
							
sbit P20=P2^0;
sbit P21=P2^1;
sbit MOTOR_SPEED_IN=P1^5;
							

const uchar code fan[8][578] = {
{24,24,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xC0,0x7E,0x03,0xC1,0x91,0x83,0xC2,0x10,0x43,0xC4,0x10,0x23,0xC8,0x10,0x13,0xD0,0x10,0x0B,
0xD0,0x10,0x0B,0xE0,0x10,0x07,0xE0,0x10,0x07,0xE0,0x1F,0xFF,0xFF,0xF8,0x07,0xE0,0x08,0x07,0xE0,0x08,0x07,0xD0,0x08,0x0B,
0xD0,0x08,0x0B,0xC8,0x08,0x13,0xC4,0x08,0x23,0xC2,0x08,0x43,0xC1,0x89,0x83,0xC0,0x7E,0x03,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
{24,24,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xC0,0x7E,0x03,0xC1,0x85,0x83,0xC2,0x04,0x43,0xC4,0x04,0x23,0xC8,0x04,0x13,0xD0,0x08,0x0B,
0xD0,0x08,0x0B,0xE0,0x08,0x07,0xFE,0x08,0x07,0xE1,0xF8,0x07,0xE0,0x1F,0x87,0xE0,0x10,0x7F,0xE0,0x10,0x07,0xD0,0x10,0x0B,
0xD0,0x10,0x0B,0xC8,0x20,0x13,0xC4,0x20,0x23,0xC2,0x20,0x43,0xC1,0xA1,0x83,0xC0,0x7E,0x03,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
{24,24,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xC0,0x7E,0x03,0xC1,0x81,0x83,0xC2,0x02,0x43,0xC4,0x02,0x23,0xC8,0x04,0x13,0xD0,0x04,0x0B,
0xD0,0x08,0x0B,0xEC,0x08,0x07,0xE3,0x10,0x07,0xE0,0xDE,0x07,0xE0,0x39,0x87,0xE0,0x08,0x67,0xE0,0x08,0x17,0xD0,0x10,0x0B,
0xD0,0x10,0x0B,0xC8,0x20,0x13,0xC4,0x20,0x23,0xC2,0x40,0x43,0xC1,0x81,0x83,0xC0,0x7E,0x03,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
{24,24,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xC0,0x7E,0x03,0xC1,0x81,0x83,0xC2,0x00,0xC3,0xC4,0x00,0xA3,0xC8,0x01,0x13,0xDC,0x01,0x0B,
0xD3,0x02,0x0B,0xE0,0xC2,0x07,0xE0,0x24,0x07,0xE0,0x18,0x07,0xE0,0x18,0x07,0xE0,0x26,0x07,0xE0,0x21,0x87,0xD0,0x40,0x6B,
0xD0,0x40,0x1B,0xC8,0x80,0x13,0xC4,0x80,0x23,0xC3,0x00,0x43,0xC1,0x81,0x83,0xC0,0x7E,0x03,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
{24,24,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xC0,0x7E,0x03,0xC1,0x81,0x83,0xC2,0x00,0x43,0xC4,0x00,0x23,0xCA,0x00,0x53,0xD1,0x00,0x8B,
0xD0,0x81,0x0B,0xE0,0x42,0x07,0xE0,0x24,0x07,0xE0,0x18,0x07,0xE0,0x18,0x07,0xE0,0x24,0x07,0xE0,0x42,0x07,0xD0,0x81,0x0B,
0xD1,0x00,0x8B,0xCA,0x00,0x53,0xC4,0x00,0x23,0xC2,0x00,0x43,0xC1,0x81,0x83,0xC0,0x7E,0x03,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
{24,24,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xC0,0x7E,0x03,0xC1,0x81,0x83,0xC3,0x00,0x43,0xC5,0x00,0x23,0xC8,0x80,0x13,0xD0,0x80,0x1B,
0xD0,0x40,0x6B,0xE0,0x41,0x87,0xE0,0x26,0x07,0xE0,0x18,0x07,0xE0,0x18,0x07,0xE0,0x24,0x07,0xE0,0xC4,0x07,0xD3,0x02,0x0B,
0xDC,0x02,0x0B,0xC8,0x01,0x13,0xC4,0x01,0x23,0xC2,0x00,0xC3,0xC1,0x81,0x83,0xC0,0x7E,0x03,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
{24,24,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xC0,0x7E,0x03,0xC1,0x81,0x83,0xC3,0x00,0x43,0xC4,0x80,0x23,0xC8,0x80,0x13,0xD0,0x40,0x0B,
0xD0,0x20,0x1B,0xE0,0x20,0x67,0xE0,0x11,0x87,0xE0,0x1E,0x07,0xE0,0x38,0x07,0xE0,0xC8,0x07,0xE3,0x08,0x07,0xDC,0x04,0x0B,
0xD0,0x04,0x0B,0xC8,0x02,0x13,0xC4,0x02,0x23,0xC2,0x01,0x43,0xC1,0x81,0x83,0xC0,0x7E,0x03,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
{24,24,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xC0,0x7E,0x03,0xC1,0xA1,0x83,0xC2,0x20,0x43,0xC4,0x20,0x23,0xC8,0x20,0x13,0xD0,0x10,0x0B,
0xD0,0x10,0x0B,0xE0,0x10,0x07,0xE0,0x10,0x7F,0xE0,0x1F,0x87,0xE1,0xF8,0x07,0xFE,0x08,0x07,0xE0,0x08,0x07,0xD0,0x08,0x0B,
0xD0,0x08,0x0B,0xC8,0x04,0x13,0xC4,0x04,0x23,0xC2,0x04,0x43,0xC1,0x85,0x83,0xC0,0x7E,0x03,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF}
};
uchar fanptr = 0;
const uchar code background[8194] = {
64,128,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,
0xCF,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,
0xDF,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,
0xFE,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3F,
0xFC,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7F,
0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xFB,
0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF3,
0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,
0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,
0xCF,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,
0xDF,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,
0xFE,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3F,
0xFC,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7F,
0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xFB,
0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF3,
0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,
0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,
0xCF,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,
0xDF,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,
0xFE,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3F,
0xFC,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7F,
0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xFB,
0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF3,
0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,
0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,
0xCF,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,
0xDF,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,
0xFE,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3F,
0xFC,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7F,
0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xFB,
0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF3,
0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,
0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,
0xCF,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,
0xDF,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,
0xFE,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3F,
0xFC,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7F,
0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xFB,
0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF3,
0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,
0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,
0xCF,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,
0xDF,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,
0xFE,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3F,
0xFC,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7F,
0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xFB,
0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF3,
0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,
0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,
0xCF,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,
0xDF,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,
0xFE,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3F,
0xFC,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7C,0x7F,
0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0xFB,
0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF1,0xF3,
0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,0xE3,
0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,0xC7,
0xCF,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,0x8F,
0xDF,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,0x1F,
0xFE,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3E,0x3F,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
};

const uchar code pic[1922]={
24,80,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xC0,0xFF,
0x1F,0x0F,0x00,0x00,0x00,0x3C,0x70,0x03,0xC0,0xFF,0x1F,0x9F,0x00,0xE3,0xFF,0x3C,
0xF0,0x03,0xC1,0xFF,0x0F,0xBE,0x70,0xE3,0xFF,0x3E,0xF7,0xFB,0xC1,0xE0,0x07,0xFE,
0x70,0xE3,0xFF,0x1F,0xF7,0xFB,0xC1,0xE0,0x03,0xFC,0x70,0xE0,0x0F,0x1F,0xE7,0xFB,
0xC1,0xC0,0x03,0xF8,0x70,0xEC,0x1E,0x0F,0xE0,0xE3,0xC1,0xE0,0x01,0xF8,0x73,0xEC,
0x1E,0x0F,0xC0,0xE3,0xC1,0xFC,0x00,0xE0,0x7F,0xE0,0x3E,0x07,0x80,0xE3,0xC1,0xFE,
0x00,0xE0,0xFF,0xE0,0x3C,0x03,0x80,0xF3,0xC0,0xFE,0x00,0xE0,0xFF,0xE0,0x7C,0x03,
0x80,0xF3,0xC0,0x1F,0x00,0xE0,0xF0,0xE0,0xF8,0x03,0x80,0xF3,0xC0,0x0F,0x01,0xE0,
0xE0,0xE0,0xF8,0x03,0x80,0x73,0xC7,0x0F,0x01,0xE0,0xE0,0xE0,0xF3,0x83,0x80,0x73,
0xC7,0xCF,0x01,0xE0,0xE0,0xE1,0xFF,0x83,0x80,0x73,0xC7,0xFF,0x01,0xC0,0xE0,0xE1,
0xFF,0x83,0x80,0x73,0xC7,0xFF,0x01,0xC0,0x00,0xE1,0xFF,0x80,0x00,0x03,0xC1,0xFE,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x03,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xFF,0xFF,0xFF,0xFF,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF
};
// delay 10*n us
void delay_10us(uchar n) {
	unsigned char i;
	for (i = n; i > 0; --i) {
		_nop_();
		//_nop_(); //12MHz
	}
}

void delay_ms(uchar n){
	while(n--){
		delay_10us(100);
	}
}

void LCD_write_byte(unsigned char Data) {
	unsigned char i;
	for (i = 0; i < 8; i++) {
		if (Data & 0x80)
			LCD_SID = 1;
		else
			LCD_SID = 0;

		_nop_();
		_nop_();
		LCD_SCLK = 0;
		_nop_();
		LCD_SCLK = 1;
		Data <<= 1;
	}
}

void loadCommand(int command) {
	int i;
	int command_bit[12];
	int temp;
	CH451_LOAD = HIGH; CH451_DCLK = HIGH;
	temp = command;
	for (i = 11; i >= 0; i--) {
		command_bit[i] = temp % 2;
		temp /= 2;
	}
	for (i = 11; i >= 0; i--) {
		CH451_DIN = command_bit[i] ^ LOW;
		CH451_DCLK = LOW; CH451_DCLK = HIGH;
	}
	CH451_LOAD = LOW; CH451_LOAD = HIGH;
	delay_ms(10);
}


void LCD_write_byte_split(unsigned char Data) {
	LCD_write_byte(Data & 0xf0);
	LCD_write_byte((Data << 4) & 0xf0);
}

void LCD_write_data(uchar Data) {
	LCD_SCLK = 0;
	LCD_write_byte(0xfa);
	_nop_();
	LCD_write_byte_split(Data);
	delay_10us(10);
}

void LCD_write_command(unsigned char command) {
	LCD_SCLK = 0;
	LCD_write_byte(0xf8);
	_nop_();
	LCD_write_byte_split(command);
	if (command == 0x01)
		delay_ms(10);
	else
		delay_10us(10);
}
void LCD_init(void) {	//初始化
	LCD_CS = LCD_RST = 1;
	LCD_write_command(0x30);	// 基本指令集
	LCD_write_command(0x08);	
	LCD_write_command(0x0c);
	LCD_write_command(0x06);	
	LCD_write_command(0x01);	
}

void LCD_setposition(uchar x,uchar y){
	LCD_write_command(char_position[x][y]);  // DDRAM
}
void LCD_setposition_dot(uchar row,uchar col){
	if(row>=32){
		LCD_write_command(0x80|(row-32));
		LCD_write_command(0x80|(col+8));
	}
	else{
		LCD_write_command(0x80|row);
		LCD_write_command(0x80|col);
	}
}
void LCD_startGraphic(){
	LCD_write_command(0x34);          // 扩展指令开启
	LCD_write_command(0x36);          // 绘图指令开启
}
void LCD_endGraphic(){
	LCD_write_command(0x36);          // 绘图指令关闭
	LCD_write_command(0x30);          // 扩展指令关闭
}

void LCD_showString(uchar x,uchar y,uchar* p){
	uchar* temp = p;
	uchar length = strlen(p);
	uchar i,j;

	// 白底黑字
	LCD_startGraphic();
	for (i = x * 16; i < x * 16 + 16; i++) {
		LCD_setposition_dot(i, y);
		for (j = 0; j < length; j++) {
			LCD_write_data(0x00);
		}
	}
	LCD_endGraphic();

	// 显示
	LCD_setposition(x, y);
	while(*p){
		LCD_write_data(*p);
		p++;
	}
	
}

void LCD_showNum_uchar(uchar x, uchar y, uchar num){
	uchar freq_str[3] = { '0',32,32};
	uchar div=100;
	uchar temp,digit=3;
	uchar i=0,j;
	temp= num;
	
	if (num > 0) {
		while (div && temp < div) {
			div /= 10; digit--;
		}
		do {
			freq_str[i++] = (uchar)(temp / div + '0');
			temp %= div;
			div /= 10;
		} while (div);
	}
	else
		digit = 1;

	// 白底黑字
	LCD_startGraphic();
	for (i = x * 16; i < x * 16 + 16; i++) {
		LCD_setposition_dot(i, y);
		for (j = 0; j < digit; j++) {
			LCD_write_data(0x00);
		}
	}
	LCD_endGraphic();

	// 显示
	LCD_setposition(x, y);
	for(i=0;i<3;i++){
		LCD_write_data(freq_str[i]);
	}
}

void LCD_showGraphic(uchar *graph, uchar start_row, uchar start_col){
	int i,j;
	int pt;
	int width,height;
	height=graph[0];width=graph[1];
	pt=2;
	LCD_startGraphic();
	for(i=0;i<height;i++){
		LCD_setposition_dot(start_row+i,start_col);
		for(j=0;j<width/8;j++){
			LCD_write_data(graph[pt]);
			pt++;
		}
	}
	LCD_endGraphic();
}
void LCD_clear() {
	uchar i,j;
	LCD_startGraphic();
	for (i = 0; i < 32; i++) {
		LCD_setposition_dot(i, 0);
		for (j = 0; j < 16; j++) {
			LCD_write_data(0x00);
		}
	}
	LCD_endGraphic();

}


void inititr() {
	EA = 1;
	EX0 = 1;		// 允许INT0外部中断
	IT0 = 1;		// INT0边沿触发
	EX1 = 1;		// 允许INT1外部中断
	IT1 = 0;		// INT1电平触发


	TMOD = 0X02;	// 定时器方式2 自动恢复初值
	TH0 = (0xff - itrtime_us);
	TL0 = (0xff - itrtime_us);
	ET0 = 1;		// 允许计时器T0中断
	TR0 = 1;		// 允许计时器T0计数
}

void test() {
	int i;
	LCD_startGraphic();
	for (i = 0; i < 8; i++) {
		LCD_setposition_dot(i, i);
		LCD_write_data(0xff);
		LCD_write_data(0xff);
		LCD_write_data(0xff);
		LCD_write_data(0xff);
	}
}


int main(){
	uchar prev_freq=255,prev_set_freq=255;
	uchar now_freq=0;
	uchar show_freq;
	uchar diff;
	LCD_init();
	LCD_clear();
	LCD_showGraphic(background, 0, 0);
	LCD_showString(2,1,"目标转速: ");
	LCD_showString(3,1,"当前转速: ");
	LCD_showGraphic(pic, 0, 0);

	CH451_DIN = 1; CH451_DIN = 0; CH451_DIN = 1;
	loadCommand(0x402);
	//loadCommand(1408);
	itr_num=type=0;
	set_freq=20;
	freq=0;
	dutycycle=10;
	inititr();
	ifarrived=0;
	while(1){
		if(prev_set_freq!=set_freq){
			prev_set_freq=set_freq;
			LCD_showNum_uchar(2, 6, set_freq);	// 显示目标转速
		}
		now_freq=show_freq=freq;
		freq=0;
		if(prev_freq!=now_freq)
			prev_freq=now_freq;
		
		if (prev_freq != set_freq) {
			if (prev_freq > set_freq) {
				diff = (uchar)((uint)step * (uint)(prev_freq - set_freq) / (uint)MAX_FREQ);
				if(!diff) diff=1;
				if (dutycycle > diff)
					dutycycle -= diff;
				else
					dutycycle = 0;
			}
			else {
				diff = (uchar)((uint)step * (uint)(set_freq - prev_freq) / (uint)MAX_FREQ);
				if(!diff) diff=1;
				if (dutycycle < 100 - diff)
					dutycycle += diff;
				else
					dutycycle = 100;
			}
			if(ifarrived){
				if(now_freq>set_freq+1)
					LCD_showNum_uchar(3, 6, set_freq+1);
				else if(now_freq<set_freq-1)
					LCD_showNum_uchar(3, 6, set_freq-1);
				else
					LCD_showNum_uchar(3, 6, set_freq);	// 显示当前转速
			}
			else
				LCD_showNum_uchar(3, 6, prev_freq);	// 显示当前转速
		}
		else 
			ifarrived=1;
		// LCD_showNum_uchar(0, 0, dutycycle);	// 显示当前占空比

		LCD_showGraphic(fan[fanptr], 0, 6);
		if(prev_freq){
			if (prev_freq < 20)
				fanptr = (fanptr + 1) % 8;
			else if (prev_freq < 40)
				fanptr = (fanptr + 2) % 8;
			else 
				fanptr = (fanptr + 4) % 8;
		}
		delay_ms(1000);
	}
}

void get_freq()interrupt 0
{
	freq++;
}

void time0()interrupt 1
{
	itr_num++;
	if(itr_num>100)
		itr_num=0;
	if(itr_num==0)
		MOTOR_SPEED_IN=MOTOR_HIGH;
	if(itr_num==dutycycle)
		MOTOR_SPEED_IN=MOTOR_LOW;	
}

void keyboard()interrupt 2
{
	int i;
	int press_bit[7];
	int presscommand;
	int flag;
	
	// get press command
	CH451_LOAD = HIGH; CH451_DCLK = HIGH;
	for (i = 0; i < 3; i++) 
	{
		CH451_DIN = 1;
		CH451_DCLK = LOW; CH451_DCLK = HIGH;
	}
	CH451_DIN = 0;
	CH451_DCLK = LOW; CH451_DCLK = HIGH;
	CH451_LOAD = LOW; CH451_LOAD = HIGH;
	for (i = 0; i < 7; i++) 
	{							/////////////////////////////////// sequence
		press_bit[i] = CH451_DOUT;
		CH451_DCLK = LOW; CH451_DCLK = HIGH;
	}
	presscommand = 0;
	for (i = 0; i < 7; i++) 
	{
		presscommand <<= 1;
		presscommand += press_bit[i];
	}
	// get press flag from presscommand
	ifarrived=0;
	switch (presscommand) {
	case 0x58:
		set_freq += 1;
		break;
	case 0x59:
		if (set_freq > 1)
			set_freq -= 1;
		else
			set_freq = 0;
		break;
	case 0x50:
		set_freq += 2;
		break;
	case 0x51:
		if (set_freq > 2)
			set_freq -= 2;
		else
			set_freq = 0;
		break;
	case 0x48:
		set_freq += 5;
		break;
	case 0x49:
		if (set_freq > 5)
			set_freq -= 5;
		else
			set_freq = 0;
		break;
	case 0x40:
		set_freq += 10;
		break;
	case 0x41:
		if (set_freq > 10)
			set_freq -= 10;
		else
			set_freq = 0;
		break;
	default:
		break;
	}
}